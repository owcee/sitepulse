rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isEngineer() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/engineer_accounts/$(request.auth.uid));
    }
    
    function isWorker() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/worker_accounts/$(request.auth.uid));
    }
    
    function getUserProjectId() {
      return isEngineer() ? 
        get(/databases/$(database)/documents/engineer_accounts/$(request.auth.uid)).data.currentProjectId :
        get(/databases/$(database)/documents/worker_accounts/$(request.auth.uid)).data.projectId;
    }
    
    function isEngineerForProject(projectId) {
      return isEngineer() && 
        get(/databases/$(database)/documents/engineer_accounts/$(request.auth.uid)).data.activeProjectIds.hasAny([projectId]);
    }
    
    // Engineer accounts - engineers can read/write their own
    match /engineer_accounts/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Worker accounts - workers can read their own, engineers can read all
    match /worker_accounts/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isEngineer());
      allow write: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Projects - engineers can create and manage, workers can read assigned project
    match /projects/{projectId} {
      allow create: if isEngineer();
      allow read: if isAuthenticated() && 
        (isEngineerForProject(projectId) || getUserProjectId() == projectId);
      allow list: if isAuthenticated() && isEngineer();
      allow update, delete: if isEngineer() && 
        resource.data.engineerId == request.auth.uid;
    }
    
    // Notifications - users can read/update their own, system can create
    match /notifications/{notificationId} {
      allow read, update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Task Photos - workers create, engineers approve/reject
    match /task_photos/{photoId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isEngineer();
      allow delete: if false;
    }
    
    // Usage Submissions - workers create, engineers review
    match /usage_submissions/{submissionId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow list: if isAuthenticated();
      allow update: if isEngineer();
      allow delete: if false;
    }
    
    // Equipment Borrow Requests - workers create, engineers approve/reject, workers can update for usage reporting and return
    match /equipment_borrow_requests/{requestId} {
      // Create: any authenticated user can create (application validates workerId)
      allow create: if isAuthenticated();
      // Read: workers can read their own, engineers can read all
      allow read: if isAuthenticated() && (
        resource.data.workerId == request.auth.uid || 
        isEngineer()
      );
      // List: authenticated users can list (queries will filter by projectId/workerId)
      allow list: if isAuthenticated();
      // Update: engineers can approve/reject, workers can update their own
      allow update: if isAuthenticated() && (
        isEngineer() || 
        resource.data.workerId == request.auth.uid
      );
      // Delete: not allowed
      allow delete: if false;
    }
    
    // Worker Assignments - engineers create, workers accept/reject
    match /worker_assignments/{workerId} {
      allow create: if isEngineer();
      allow read: if isAuthenticated() && 
        (request.auth.uid == workerId || isEngineer());
      allow update: if isAuthenticated() && 
        (request.auth.uid == workerId || isEngineer());
      allow delete: if isEngineer();
    }
    
    // Project data - users can only access their project's data
    match /materials/{materialId} {
      allow read, write: if isAuthenticated() && 
        resource.data.projectId == getUserProjectId();
      allow create: if isAuthenticated();
    }
    
    match /workers/{workerId} {
      allow read, write: if isAuthenticated() && 
        resource.data.projectId == getUserProjectId();
      allow create: if isAuthenticated();
    }
    
    match /equipment/{equipmentId} {
      allow read, write: if isAuthenticated() && 
        resource.data.projectId == getUserProjectId();
      allow create: if isAuthenticated();
    }
    
    match /budget_logs/{logId} {
      allow read, write: if isAuthenticated() && 
        resource.data.projectId == getUserProjectId();
      allow create: if isAuthenticated();
    }
    
    // Budgets - document ID is projectId, users can access budgets for their project
    match /budgets/{projectId} {
      // Helper: check if user is engineer for this project (by checking project's engineerId)
      function isEngineerForBudgetProject() {
        return isEngineer() && 
          exists(/databases/$(database)/documents/projects/$(projectId)) &&
          get(/databases/$(database)/documents/projects/$(projectId)).data.engineerId == request.auth.uid;
      }
      
      // Read: allow if user is authenticated and their projectId matches the document ID
      // OR if they are the engineer for this project
      allow read: if isAuthenticated() && 
        (getUserProjectId() == projectId || isEngineerForBudgetProject());
      
      // Create/Update: allow engineers for their current project, workers for their assigned project
      // OR if they are the engineer for this project (needed when creating new projects)
      // For create: check request.resource.data doesn't exist yet, so check project's engineerId
      allow create: if isAuthenticated() && 
        (getUserProjectId() == projectId || 
         (isEngineer() && 
          exists(/databases/$(database)/documents/projects/$(projectId)) &&
          get(/databases/$(database)/documents/projects/$(projectId)).data.engineerId == request.auth.uid));
      
      // Update: same conditions as create
      allow update: if isAuthenticated() && 
        (getUserProjectId() == projectId || isEngineerForBudgetProject());
      
      // Prevent deletion of budgets
      allow delete: if false;
    }
    
    // Tasks - engineers can manage, workers can read their assigned tasks
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && (
        isEngineerForProject(resource.data.projectId) || 
        request.auth.uid in resource.data.assigned_worker_ids
      );
      allow create, update, delete: if isAuthenticated() && 
        isEngineerForProject(request.resource.data.projectId);
    }
    
    // Chat messages - all project members can read and create
    match /chat_messages/{messageId} {
      // Read: check existing message's projectId
      allow read: if isAuthenticated() && (
        isEngineerForProject(resource.data.projectId) || 
        getUserProjectId() == resource.data.projectId
      );
      // Create: check new message's projectId from request
      allow create: if isAuthenticated() && (
        isEngineerForProject(request.resource.data.projectId) || 
        getUserProjectId() == request.resource.data.projectId
      );
      // Update/Delete: only sender can modify their own messages
      allow update, delete: if isAuthenticated() && 
        resource.data.senderId == request.auth.uid;
    }
    
    // Survey tracking - users can read/write their own survey tracking
    // Document ID format: userId_projectId (composite key for per-project tracking)
    match /survey_tracking/{trackingId} {
      // Allow if authenticated and:
      // 1. Document exists and userId field matches, OR
      // 2. Creating new document and userId in request matches
      allow read: if isAuthenticated() && 
        (resource == null || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;
    }
    
    // Site surveys - engineers can create, read their project's surveys
    match /site_surveys/{surveyId} {
      allow create: if isAuthenticated() && isEngineer();
      allow read: if isAuthenticated();
    }
    
    // Delay predictions - system creates, users can read
    match /delayPredictions/{predictionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }
  }
}

